{{ template "layout.html" . }}

{{ define "title" }}Редактирование пользователя {{ .User.Username }} - Админ-панель{{ end }}

{{ define "content" }}
    <nav aria-label="breadcrumb">
        <ul>
            <li><a href="/admin/dashboard">Дашборд</a></li>
            <li><a href="/admin/users">Пользователи</a></li>
            <li>Редактирование: {{ .User.Username }}</li>
        </ul>
    </nav>

    <h1>Редактирование пользователя #{{ .User.ID }} - {{ .User.Username }}</h1>

    {{ if .Error }}
        <article aria-invalid="true">
            {{ .Error }}
        </article>
    {{ end }}
    {{ if .Success }}
        <article style="background-color: var(--pico-color-green-150); border-color: var(--pico-color-green-400);">
            {{ .Success }}
        </article>
    {{ end }}

    <form method="post" action="/admin/users/{{ .User.ID }}"> 
        <div class="grid">
            <label for="username">
                Имя пользователя (Username)
                <input type="text" id="username" name="username" value="{{ .User.Username }}" readonly disabled>
            </label>
            <label for="email">
                Email
                <input type="email" id="email" name="email" value="{{ .User.Email }}" required>
            </label>
        </div>
        
        <label for="roles">Роли</label>
        <select id="roles" name="roles" multiple required>
            {{ range $role := .AllRoles }} 
                <option value="{{ $role }}" {{ if hasRole $.CurrentUserRoles $role }}selected{{ end }}>
                    {{ $role }}
                </option>
            {{ end }}
        </select>

        <fieldset>
            <legend>Статус</legend>
            <label for="is_banned">
                <input type="checkbox" id="is_banned" name="is_banned" value="true" {{ if .User.IsBanned }}checked{{ end }}>
                Забанен
            </label>
        </fieldset>

        <button type="submit">Сохранить изменения</button>
        <a href="/admin/users" role="button" class="secondary">Отмена</a>
    </form>

    <hr>

    <h2>Контент пользователя</h2>
    <div class="grid">
        <a href="/admin/users/{{ .User.ID }}/drafts" role="button" class="outline">Черновики пользователя</a>
        <a href="/admin/users/{{ .User.ID }}/stories" role="button" class="outline">Опубликованные истории</a>
    </div>

    <hr>

    <h2>Сброс пароля</h2>
    <p>Нажмите кнопку ниже, чтобы сгенерировать новый случайный пароль для пользователя. 
    <strong>Внимание:</strong> Текущий пароль будет утерян, а все активные сессии пользователя будут завершены.
    </p>
    
    {{/* Кнопка для сброса пароля через HTMX */}}
    <button 
        hx-post="/admin/users/{{ .User.ID }}/reset-password" 
        hx-target="#password-reset-status" 
        hx-swap="innerHTML" 
        hx-confirm="Вы уверены, что хотите сбросить пароль для пользователя {{ .User.Username }}? Это действие необратимо."
        class="secondary">
        Сбросить пароль
    </button>

    {{/* Див для отображения результата сброса пароля */}}
    <div id="password-reset-status" style="margin-top: 1em;"></div>

    <hr>

    <!-- <<< Форма отправки уведомления >>> -->
    <h2>Отправить уведомление</h2>

    {{/* <<< Блок отображения статуса отправки >>> */}}
    {{ if eq .NotificationStatus "success" }}
        <article style="background-color: var(--pico-color-green-150); border-color: var(--pico-color-green-400); margin-bottom: 1em;">
            Уведомление успешно отправлено в очередь!
        </article>
    {{ else if eq .NotificationStatus "error" }}
        <article aria-invalid="true" style="margin-bottom: 1em;">
            Ошибка при отправке уведомления в очередь.
        </article>
    {{ end }}
    {{/* <<< Конец блока статуса >>> */}}

    <div id="notification-section">
        <div class="mb-3">
            <label for="notificationMessage" class="form-label">Текст уведомления:</label>
            <textarea class="form-control" id="notificationMessage" rows="3"></textarea>
        </div>
        <button type="button" class="btn btn-info" id="sendNotificationBtn" data-user-id="{{.User.ID}}">Отправить уведомление</button>
    </div>

    <hr>

    <a href="/admin/users" class="btn btn-secondary">Назад к списку пользователей</a>
    <a href="/admin/users/{{.User.ID}}/stories" class="btn btn-outline-primary ms-2">Истории пользователя</a>
    <a href="/admin/users/{{.User.ID}}/drafts" class="btn btn-outline-secondary ms-2">Черновики пользователя</a>

    <!-- <<< JavaScript для отправки уведомления >>> -->
    <script>
    document.getElementById('sendNotificationBtn').addEventListener('click', function() {
        const userId = this.getAttribute('data-user-id');
        const message = document.getElementById('notificationMessage').value.trim();
        const statusDiv = document.getElementById('notificationStatus');
        const sendButton = this;

        if (!message) {
            statusDiv.textContent = 'Введите текст уведомления.';
            statusDiv.className = 'mt-2 text-danger';
            return;
        }

        statusDiv.textContent = 'Отправка...';
        statusDiv.className = 'mt-2 text-info';
        sendButton.disabled = true;

        fetch(`/admin/users/${userId}/send-notification`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                // Добавить 'Authorization': 'Bearer ' + token, если используется
            },
            body: JSON.stringify({ message: message })
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => { throw new Error(err.error || `Ошибка ${response.status}`) });
            }
            return response.json();
        })
        .then(data => {
            statusDiv.textContent = 'Уведомление успешно отправлено в очередь!';
            statusDiv.className = 'mt-2 text-success';
            document.getElementById('notificationMessage').value = ''; // Очистить поле
        })
        .catch(error => {
            console.error('Ошибка отправки уведомления:', error);
            statusDiv.textContent = `Ошибка: ${error.message || 'Не удалось отправить'}`;
            statusDiv.className = 'mt-2 text-danger';
        })
        .finally(() => {
            sendButton.disabled = false;
        });
    });
    </script>
{{ end }} 