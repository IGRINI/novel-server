{{ template "layout.html" . }}

{{ define "title" }}Редактирование пользователя {{ .User.Username }}{{ end }}

{{ define "content" }}
    <nav class="breadcrumbs">
        <ul>
            <li><a href="/admin/dashboard">Дашборд</a></li>
            <li><a href="/admin/users">Пользователи</a></li>
            <li>Редактирование: {{ .User.Username }}</li>
        </ul>
    </nav>

    <h1>Редактирование пользователя #{{ .User.ID }} - {{ .User.Username }}</h1>

    {{ if .Error }}
        <div class="system-message system-message--error">{{ .Error }}</div>
    {{ end }}
    {{ if .Success }}
        <div class="system-message system-message--success">{{ .Success }}</div>
    {{ end }}

    <form method="post" action="/admin/users/{{ .User.ID }}" class="data-form">
        <div>
            <label for="username">
                Имя пользователя (Username)
            </label>
            <input type="text" id="username" name="username" value="{{ .User.Username }}" readonly disabled>
        </div>
        <div>
            <label for="email">
                Email
            </label>
            <input type="email" id="email" name="email" value="{{ .User.Email }}" required>
        </div>
        <div>
            <label for="display_name">
                Отображаемое имя (Display Name)
            </label>
            <input type="text" id="display_name" name="display_name" value="{{ .User.DisplayName }}">
        </div>
        
        <label for="roles">Роли</label>
        <select id="roles" name="roles" multiple required>
            {{ range $role := .AllRoles }} 
                <option value="{{ $role }}" {{ if hasRole $.CurrentUserRoles $role }}selected{{ end }}>
                    {{ $role }}
                </option>
            {{ end }}
        </select>

        <fieldset>
            <legend>Статус</legend>
            <label for="is_banned" style="display: inline-flex; align-items: center;">
                <input type="checkbox" id="is_banned" name="is_banned" value="true" {{ if .User.IsBanned }}checked{{ end }}>
                Забанен
            </label>
        </fieldset>

        <div class="button-group">
            <button type="submit" class="cta-button cta-button--primary">Сохранить изменения</button>
            <a href="/admin/users" role="button" class="cta-button cta-button--secondary">Отмена</a>
        </div>
    </form>

    <hr>

    <h2>Контент пользователя</h2>
    <div class="button-group">
        <a href="/admin/users/{{ .User.ID }}/drafts" role="button" class="cta-button cta-button--secondary">Черновики пользователя</a>
        <a href="/admin/users/{{ .User.ID }}/stories" role="button" class="cta-button cta-button--secondary">Опубликованные истории</a>
    </div>

    <hr>

    <h2>Сброс пароля</h2>
    <p>Нажмите кнопку ниже, чтобы сгенерировать новый случайный пароль для пользователя. 
    <strong>Внимание:</strong> Текущий пароль будет утерян, а все активные сессии пользователя будут завершены.
    </p>
    
    <button 
        hx-post="/admin/users/{{ .User.ID }}/reset-password" 
        hx-target="#password-reset-status" 
        hx-swap="innerHTML" 
        hx-confirm="Вы уверены, что хотите сбросить пароль для пользователя {{ .User.Username }}? Это действие необратимо."
        class="cta-button cta-button--secondary">
        Сбросить пароль
    </button>

    <div id="password-reset-status" style="margin-top: 1em;"></div>

    <hr>

    <h2>Отправить уведомление</h2>

    {{ if eq .NotificationStatus "success" }}
        <div class="system-message system-message--success" style="margin-bottom: 1em;">
            Уведомление успешно отправлено в очередь!
        </div>
    {{ else if eq .NotificationStatus "error" }}
        <div class="system-message system-message--error" style="margin-bottom: 1em;">
            Ошибка при отправке уведомления в очередь.
        </div>
    {{ end }}

    <div id="notification-section" class="data-form">
        <div class="mb-3">
            <label for="notificationMessage" class="form-label">Текст уведомления:</label>
            <textarea id="notificationMessage" rows="3"></textarea>
        </div>
        <button type="button" class="cta-button cta-button--secondary" id="sendNotificationBtn" data-user-id="{{.User.ID}}">Отправить уведомление</button>
        <div id="notificationStatus" class="mt-2"></div>
    </div>

    <hr>

    <div class="button-group">
        <a href="/admin/users" class="cta-button cta-button--secondary">Назад к списку пользователей</a>
        <a href="/admin/users/{{.User.ID}}/stories" class="cta-button cta-button--secondary">Истории пользователя</a>
        <a href="/admin/users/{{.User.ID}}/drafts" class="cta-button cta-button--secondary">Черновики пользователя</a>
    </div>

    <script>
    document.getElementById('sendNotificationBtn').addEventListener('click', function() {
        const userId = this.getAttribute('data-user-id');
        const message = document.getElementById('notificationMessage').value.trim();
        const statusDiv = document.getElementById('notificationStatus');
        const sendButton = this;

        if (!message) {
            statusDiv.textContent = 'Введите текст уведомления.';
            statusDiv.className = 'mt-2 text-danger';
            return;
        }

        statusDiv.textContent = 'Отправка...';
        statusDiv.className = 'mt-2 text-info';
        sendButton.disabled = true;
        sendButton.style.opacity = '0.7';

        fetch(`/admin/users/${userId}/send-notification`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ message: message })
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => { throw new Error(err.error || `Ошибка ${response.status}`) });
            }
            return response.json();
        })
        .then(data => {
            statusDiv.textContent = 'Уведомление успешно отправлено в очередь!';
            statusDiv.className = 'mt-2 text-success';
            document.getElementById('notificationMessage').value = '';
        })
        .catch(error => {
            console.error('Ошибка отправки уведомления:', error);
            statusDiv.textContent = `Ошибка: ${error.message || 'Не удалось отправить'}`;
            statusDiv.className = 'mt-2 text-danger';
        })
        .finally(() => {
            sendButton.disabled = false;
            sendButton.style.opacity = '1';
        });
    });
    </script>
{{ end }} 