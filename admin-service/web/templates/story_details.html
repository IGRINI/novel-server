{{ template "_layout.html" . }}

{{ define "content" }}
<div class="app-container">
    <h2>{{ .PageTitle }}</h2>

    {{ if .URLQuery.Get "success" }}
        <div class="system-message system-message--success">{{ if eq (.URLQuery.Get "success") "updated" }}История успешно обновлена!{{ else }}Операция успешна!{{ end }}</div>
    {{ end }}
    {{ if .URLQuery.Get "error" }}
        <div class="system-message system-message--error">{{ if eq (.URLQuery.Get "error") "update_failed" }}Ошибка обновления истории: {{ $msg := .URLQuery.Get "msg" }}{{ if $msg }}{{ $msg }}{{ else }}Неизвестная ошибка.{{ end }}{{ else }}Произошла ошибка.{{ end }}</div>
    {{ end }}

    {{ if .UserError }}
        <div class="system-message system-message--warning">{{ .UserError }}</div>
    {{ end }}
    {{ if .StoryError }}
        <div class="system-message system-message--error">{{ .StoryError }}</div>
    {{ end }}
    {{ if .ScenesError }}
        <div class="system-message system-message--warning">{{ .ScenesError }}</div>
    {{ end }}
    {{ if .SuccessMessage }}
        <div class="system-message system-message--success">{{ .SuccessMessage }}</div>
    {{ end }}
    {{ if .ErrorMessage }}
        <div class="system-message system-message--error">{{ .ErrorMessage }}</div>
    {{ end }}

    {{ if and (not .UserError) .TargetUser }}
        <div class="content-card mb-3">
            <div class="content-card-header">Пользователь</div>
            <div class="content-card-body">
                <p><strong>ID:</strong> {{ .TargetUser.ID }}</p>
                <p><strong>Username:</strong> {{ .TargetUser.Username }}</p>
                <p><strong>Email:</strong> {{ .TargetUser.Email }}</p>
                <a href="/admin/users/{{.TargetUser.ID}}/edit" class="cta-button cta-button--secondary btn-sm">Редактировать пользователя</a>
            </div>
        </div>
    {{ end }}

    {{ if and (not .StoryError) .Story }}
        <form method="POST" action="/admin/users/{{ .TargetUser.ID }}/stories/{{ .Story.ID }}" class="data-form">
            <div class="content-card mb-3">
                <div class="content-card-header">Детали опубликованной истории</div>
                <div class="content-card-body">
                    <p><strong>ID Истории:</strong> {{ .Story.ID }}</p>
                    <p><strong>Заголовок:</strong> {{ $title := .Story.Title | derefString }}{{ if $title }}{{ $title }}{{ else }}-{{ end }}</p>
                    <p><strong>Описание:</strong> {{ $desc := .Story.Description | derefString }}{{ if $desc }}{{ $desc }}{{ else }}-{{ end }}</p>
                    <div class="mb-3">
                        <label for="status" class="form-label"><strong>Статус:</strong></label>
                        <select id="status" name="status">
                            {{ range .AvailableStatuses }}
                                <option value="{{ . }}" {{ if eq . $.Story.Status }}selected{{ end }}>{{ . }}</option>
                            {{ else }}
                                <option value="{{ $.Story.Status }}" selected>{{ $.Story.Status }} (нет доступных)</option>
                            {{ end }}
                        </select>
                    </div>
                    <p><strong>Публичная:</strong> {{ if .Story.IsPublic }}Да{{ else }}Нет{{ end }}</p>
                    <p><strong>18+:</strong> {{ if .Story.IsAdultContent }}Да{{ else }}Нет{{ end }}</p>
                    <p><strong>Создана (опубл.):</strong> {{ .Story.CreatedAt | formatAsDateTime }}</p>
                    <p><strong>Обновлена:</strong> {{ .Story.UpdatedAt | formatAsDateTime }}</p>
                    <p><strong>Лайки:</strong> {{ .Story.LikesCount }}</p>

                    <div class="mb-3">
                        <label for="configJson" class="form-label"><strong>Config (JSON):</strong></label>
                        <textarea id="configJson" name="configJson" rows="15">{{ .Story.Config | bytesToString }}</textarea>
                    </div>

                    <div class="mb-3">
                        <label for="setupJson" class="form-label"><strong>Setup (JSON):</strong></label>
                        <textarea id="setupJson" name="setupJson" rows="15">{{ .Story.Setup | bytesToString }}</textarea>
                    </div>
                </div>
                <div class="content-card-footer">
                    <button type="submit" class="cta-button cta-button--primary">Сохранить изменения (Config/Setup)</button>
                    <button type="button" class="cta-button cta-button--secondary" onclick="formatJsonTextarea('configJson')">Форматировать Config</button>
                    <button type="button" class="cta-button cta-button--secondary" onclick="formatJsonTextarea('setupJson')">Форматировать Setup</button>
                </div>
            </div>
        </form>

        <div class="content-card mb-3">
            <div class="content-card-header">Сцены истории ({{ len .Scenes }})</div>
            <div class="content-card-body">
                {{ if .ScenesError }}
                    <div class="system-message system-message--warning">Не удалось загрузить сцены: {{ .ScenesError }}</div>
                {{ else }}
                    <table class="data-table table-sm table-striped">
                        <thead>
                            <tr>
                                <th>ID Сцены</th>
                                <th>Хеш состояния</th>
                                <th>Дата создания</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            {{ range .Scenes }}
                                <tr>
                                    <td><small>{{ .ID }}</small></td>
                                    <td><small>{{ .StateHash }}</small></td>
                                    <td><small>{{ .CreatedAt | formatAsDateTime }}</small></td>
                                    <td>
                                        <button class="cta-button cta-button--secondary btn-sm" onclick="showSceneContent('{{ .ID }}')">Показать/Редактировать JSON</button>
                                        <textarea id="scene-{{ .ID }}" style="display: none;">{{ .Content | bytesToString }}</textarea>
                                        <button class="cta-button cta-button--danger btn-sm"
                                                hx-delete="/admin/users/{{$.TargetUser.ID}}/stories/{{$.Story.ID}}/scenes/{{.ID}}"
                                                hx-confirm="Вы уверены, что хотите удалить сцену {{ .ID }}?"
                                                hx-target="closest tr"
                                                hx-swap="outerHTML">
                                            Удалить
                                        </button>
                                    </td>
                                </tr>
                            {{ else }}
                                <tr>
                                    <td colspan="4">Сцены для этой истории еще не сгенерированы или не найдены.</td>
                                </tr>
                            {{ end }}
                        </tbody>
                    </table>
                {{ end }}
            </div>
        </div>

        <!-- <<< Добавлено: Секция прогресса игроков >>> -->
        <div class="content-card mb-3">
            <div class="content-card-header">Прогресс игроков</div>
            <div class="content-card-body">
                {{ if .PlayerStatesError }}
                    <div class="system-message system-message--warning">{{ .PlayerStatesError }}</div>
                {{ else }}
                    <table class="data-table table-sm table-striped">
                        <thead>
                            <tr>
                                <th>ID Игрока</th>
                                <th>ID Прогресса</th>
                                <th>Статус Игрока</th>
                                <th>Посл. активность</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            {{ range $state := .PlayerStates }}
                                <tr>
                                    <td><small>{{ $state.PlayerID }}</small></td>
                                    <td><small>{{ if $state.PlayerProgressID }}{{ $state.PlayerProgressID }}{{ else }}-{{ end }}</small></td>
                                    <td>{{ $state.PlayerStatus }}</td>
                                    <td><small>{{ $state.LastActivityAt | formatAsDateTime }}</small></td>
                                    <td>
                                        {{ if $state.PlayerProgressID }}
                                            <a href="/admin/users/{{ $.TargetUser.ID }}/stories/{{ $.Story.ID }}/progress/{{ $state.PlayerProgressID }}/edit" class="cta-button cta-button--secondary btn-sm" style="margin-right: 0.5rem;">Редактировать прогресс</a>
                                            <button class="cta-button cta-button--danger btn-sm" style="margin-right: 0.5rem;"
                                                    hx-delete="/admin/users/{{$.TargetUser.ID}}/stories/{{$.Story.ID}}/progress/{{ $state.PlayerProgressID }}"
                                                    hx-confirm="Вы уверены, что хотите удалить прогресс {{ $state.PlayerProgressID }}?"
                                                    hx-target="closest tr"
                                                    hx-swap="outerHTML">
                                                Удалить прогресс
                                            </button>
                                        {{ end }}
                                        <button class="cta-button cta-button--danger btn-sm"
                                                hx-delete="/admin/users/{{$.TargetUser.ID}}/stories/{{$.Story.ID}}/players/{{ $state.PlayerID }}"
                                                hx-confirm="Вы уверены, что хотите удалить состояние игрока {{ $state.PlayerID }}?"
                                                hx-target="closest tr"
                                                hx-swap="outerHTML">
                                            Удалить состояние
                                        </button>
                                    </td>
                                </tr>
                            {{ else }}
                                <tr>
                                    <td colspan="5">Для этой истории нет активных или сохраненных сессий игроков.</td>
                                </tr>
                            {{ end }}
                        </tbody>
                    </table>
                {{ end }}
            </div>
        </div>
        <!-- <<< Конец секции прогресса игроков >>> -->

    {{ else if not .StoryError }}
        <div class="system-message system-message--info">Информация об истории недоступна.</div>
    {{ end }}

    <!-- Панель редактирования сцены снизу -->
    <div id="sceneJsonPanel" style="display:none; position:fixed; bottom:0; left:0; width:100%; max-height:50%; overflow:auto; background:var(--card-background); border-top:1px solid rgba(0,0,0,0.1); padding:1rem; z-index:1000;">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h5 style="margin:0;">Содержимое сцены <span id="scenePanelTitle"></span></h5>
        <button class="cta-button cta-button--secondary" onclick="hideScenePanel()">Закрыть</button>
      </div>
      <textarea id="scenePanelJsonContentEditable" rows="15" style="width:100%; margin-top:0.5rem;"></textarea>
      <div style="margin-top:0.5rem;">
        <button class="cta-button cta-button--secondary" onclick="formatScenePanelJson()">Форматировать</button>
        <button class="cta-button cta-button--primary" onclick="saveScenePanelContent()">Сохранить</button>
      </div>
    </div>

    <a href="/admin/users/{{ .TargetUser.ID }}/stories" class="cta-button cta-button--secondary mt-3">Назад к списку историй</a>
</div>

<script>
function formatJsonTextarea(textareaId) {
    const textarea = document.getElementById(textareaId);
    if (textarea && textarea.value.trim()) {
        try {
            const jsonObject = JSON.parse(textarea.value);
            textarea.value = JSON.stringify(jsonObject, null, 2);
        } catch (e) {
            alert(`Некорректный JSON в поле ${textareaId}!`);
        }
    }
}

document.addEventListener('DOMContentLoaded', () => {
    formatJsonTextarea('configJson');
    formatJsonTextarea('setupJson');
});

function formatScenePanelJson() {
    const ta = document.getElementById('scenePanelJsonContentEditable');
    try {
        const obj = JSON.parse(ta.value);
        ta.value = JSON.stringify(obj, null, 2);
    } catch {
        alert('Некорректный JSON!');
    }
}

function showSceneContent(sceneId) {
    const orig = document.getElementById(`scene-${sceneId}`);
    const panel = document.getElementById('sceneJsonPanel');
    const ta = document.getElementById('scenePanelJsonContentEditable');
    const title = document.getElementById('scenePanelTitle');
    ta.value = orig ? orig.value : '';
    title.textContent = sceneId;
    panel.style.display = 'block';
}

function hideScenePanel() {
    document.getElementById('sceneJsonPanel').style.display = 'none';
}

function saveScenePanelContent() {
    const sceneId = document.getElementById('scenePanelTitle').textContent;
    const contentJson = document.getElementById('scenePanelJsonContentEditable').value;
    try { JSON.parse(contentJson); } catch { alert('Некорректный JSON!'); return; }
    const userId = '{{ .TargetUser.ID }}';
    const storyId = '{{ .Story.ID }}';
    fetch(`/admin/users/${userId}/stories/${storyId}/scenes/${sceneId}`, {
        method: 'POST',
        headers: { 'Content-Type':'application/json','Accept':'application/json' },
        body: JSON.stringify({ contentJson })
    })
    .then(res => {
        if (!res.ok) throw new Error();
        document.getElementById(`scene-${sceneId}`).value = contentJson;
        hideScenePanel();
    })
    .catch(() => alert('Ошибка сохранения сцены'));
}
</script>

{{ end }} 