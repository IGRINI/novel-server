{{ template "layout.html" . }}

{{ define "title" }}{{ .PageTitle }}{{ end }}

{{ define "breadcrumbs" }}
<nav class="breadcrumbs">
    <ul>
        <li><a href="/admin/dashboard">Дашборд</a></li>
        <li><a href="/admin/users">Пользователи</a></li>
        <li><a href="/admin/users/{{ .TargetUser.ID }}/edit">{{ .TargetUser.Username }}</a></li>
        <li>Опубликованные истории</li>
    </ul>
</nav>
{{ end }}

{{ define "content" }}
    <h1>{{ .PageTitle }}</h1>

    {{ if .Error }}
        <div class="system-message system-message--error">{{ .Error }}</div>
    {{ end }}

    <table class="data-table">
        <thead>
            <tr>
                <th>ID Истории</th>
                <th>Название</th>
                <th>Описание</th>
                <th>Статус</th>
                <th>Публичная</th>
                <th>Контент для взрослых</th>
                <th>Лайки</th>
                <th>Дата создания</th>
                <th>Дата обновления</th>
                <th>Действия</th>
            </tr>
        </thead>
        <tbody>
            {{ range .Stories }}
                <tr>
                    <td><a href="/admin/users/{{ $.User.ID }}/stories/{{ .ID }}">{{ .ID }}</a></td>
                    <td>{{ $title := .Title | derefString }}{{ if $title }}{{ $title }}{{ else }}-{{ end }}</td>
                    <td>{{ $desc := .Description | derefString }}{{ if $desc }}{{ $desc }}{{ else }}-{{ end }}</td>
                    <td><span class="status-badge status-{{ .Status }}">{{ .Status }}</span></td>
                    <td>{{ if .IsPublic }}Да{{ else }}Нет{{ end }}</td>
                    <td>{{ if .IsAdultContent }}Да{{ else }}Нет{{ end }}</td>
                    <td>{{ .LikesCount }}</td>
                    <td>{{ .CreatedAt | formatAsDateTime }}</td>
                    <td>{{ .UpdatedAt | formatAsDateTime }}</td>
                    <td>
                        <a href="/admin/users/{{$.TargetUser.ID}}/stories/{{.ID}}" class="cta-button cta-button--secondary btn-sm" style="margin-right: 0.5rem;">Детали</a>
                        <button class="cta-button cta-button--danger btn-sm"
                                hx-delete="/admin/users/{{$.TargetUser.ID}}/stories/{{.ID}}"
                                hx-confirm="Вы уверены, что хотите удалить историю '{{ $title := .Title | derefString }}{{ if $title }}{{ $title }}{{ else }}{{ .ID }}{{ end }}'? Это действие нельзя отменить."
                                hx-target="closest tr"
                                hx-swap="outerHTML">
                            Удалить
                        </button>
                    </td>
                </tr>
            {{ else }}
                <tr>
                    <td colspan="6">Опубликованные истории у пользователя не найдены.</td>
                </tr>
            {{ end }}
        </tbody>
    </table>

    {{/* Пагинация по offset */}}
    <nav aria-label="Pagination">
        <ul>
            <li>
                {{/* Кнопка Назад */}}
                {{ $calculatedOffset := sub .Offset .Limit }}
                {{ $prevOffset := 0 }} {{/* Значение по умолчанию 0 */}}
                {{ if gt $calculatedOffset 0 }}
                    {{ $prevOffset = $calculatedOffset }}
                {{ end }}
                {{ if gt .Offset 0 }}
                    <a href="/admin/users/{{ .TargetUser.ID }}/stories?limit={{ .Limit }}&offset={{ $prevOffset }}" role="button" class="cta-button">← Предыдущая страница</a>
                {{ else }}
                    <button disabled aria-disabled="true" class="cta-button" style="opacity: 0.6; cursor: not-allowed;">← Предыдущая страница</button>
                {{ end }}
            </li>
            <li>
                {{/* Кнопка Вперед */}}
                {{ $nextOffset := add .Offset .Limit }}
                {{ if .HasMore }}
                    <a href="/admin/users/{{ .TargetUser.ID }}/stories?limit={{ .Limit }}&offset={{ $nextOffset }}" role="button" class="cta-button">Следующая страница →</a>
                {{ else }}
                    <button disabled aria-disabled="true" class="cta-button" style="opacity: 0.6; cursor: not-allowed;">Следующая страница →</button>
                {{ end }}
            </li>
        </ul>
    </nav>

{{ end }} 