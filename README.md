# Novel Server

Серверное приложение для генерации и управления интерактивными новеллами с использованием нейросетей.

## Возможности

- Генерация интерактивных новелл с помощью нейросетей
- Управление сценариями и ветвлениями сюжета
- Сохранение состояния прогресса игрока
- Реализация выбора персонажей и их взаимодействий
- WebSocket для обновлений в режиме реального времени
- REST API для интеграции с любыми клиентскими приложениями

## Технический стек

- Go 1.22+
- PostgreSQL
- RESTful API
- WebSockets
- DeepSeek API через OpenRouter

## Установка и запуск

### Предварительные требования

- Go 1.22+
- PostgreSQL 14+
- Аккаунт на OpenRouter для доступа к DeepSeek API

### Клонирование репозитория

```bash
git clone https://github.com/yourusername/novel-server.git
cd novel-server
```

### Настройка .env файла

Скопируйте файл `.env.example` в `.env` и настройте его согласно вашим требованиям:

```bash
cp .env.example .env
# Отредактируйте переменные окружения в .env
```

#### Важные настройки в .env

```
# Настройки API для нейросети
AI_API_KEY=ваш-ключ-openrouter-api
AI_MODEL=deepseek/deepseek-chat-v3-0324:free
AI_BASE_URL=https://openrouter.ai/api/v1
AI_TIMEOUT=60
AI_MAX_ATTEMPTS=3
```

Для использования DeepSeek API через OpenRouter:
1. Зарегистрируйтесь на [OpenRouter](https://openrouter.ai/)
2. Получите API ключ
3. Укажите его в переменной `AI_API_KEY`

### Установка зависимостей

```bash
go mod download
```

### Запуск миграций

```bash
go run cmd/migrate/main.go up
```

### Запуск сервера

```bash
go run main.go
```

Или для запуска в режиме разработки:

```bash
go run cmd/server/main.go
```

## API

### Авторизация

- `POST /api/auth/register` - Регистрация нового пользователя
- `POST /api/auth/login` - Вход в систему
- `POST /api/auth/refresh` - Обновление токена

### Новеллы

- `GET /api/novels` - Получение списка доступных новелл
- `POST /api/novels` - Создание новой новеллы
- `GET /api/novels/{id}` - Получение информации о новелле
- `PUT /api/novels/{id}` - Обновление новеллы
- `DELETE /api/novels/{id}` - Удаление новеллы
- `GET /api/novels/{id}/scenes` - Получение всех сцен новеллы

### Генерация контента

- `POST /api/generate/config` - Генерация конфигурации новеллы
- `POST /api/generate/content` - Генерация содержимого новеллы
- `GET /api/tasks/{id}` - Проверка статуса задачи генерации

### Состояния новелл

- `GET /api/novels/{novelId}/state` - Получение состояния новеллы
- `POST /api/novels/{novelId}/state` - Сохранение состояния новеллы

### WebSocket

- `WebSocket /ws` - Подключение к WebSocket для получения обновлений в реальном времени

## Структура проекта

```
├── cmd/                  # Исполняемые файлы приложения
│   ├── migrate/          # Команды для миграций БД
│   └── server/           # Основной сервер приложения
├── internal/             # Внутренний код приложения
│   ├── config/           # Конфигурация приложения
│   ├── delivery/         # Слой доставки (HTTP, WebSocket)
│   │   ├── http/         # HTTP обработчики
│   │   └── websocket/    # WebSocket обработчики
│   ├── middleware/       # Промежуточное ПО (аутентификация и т.д.)
│   ├── model/            # Модели данных
│   ├── repository/       # Репозитории для работы с базой данных
│   └── service/          # Бизнес-логика приложения
├── migrations/           # Файлы миграций БД
├── pkg/                  # Общие пакеты и утилиты
│   ├── ai/               # Клиент для работы с нейросетями
│   ├── database/         # Утилиты для работы с БД
│   ├── migration/        # Инструменты для миграций БД
│   └── taskmanager/      # Менеджер асинхронных задач
├── .env                  # Переменные окружения
├── .env.example          # Пример файла с переменными окружения
├── go.mod                # Go модули
├── go.sum                # Go зависимости
├── main.go               # Точка входа приложения
└── README.md             # Документация по проекту
```

## Архитектурные особенности

### Система управления задачами

В приложении реализована система управления асинхронными задачами через пакет `pkg/taskmanager`. Она обеспечивает:

- Асинхронное выполнение длительных операций (генерация контента)
- Отслеживание статуса выполнения задач
- Возможность отмены задач
- Уведомления о завершении задач через WebSocket

Система использует интерфейс `ITaskManager`, что упрощает тестирование и замену реализации менеджера задач.

### Работа с нейронными сетями

Приложение использует DeepSeek API через OpenRouter для генерации контента новелл. Это позволяет:

- Генерировать более креативные и разнообразные сюжеты
- Улучшить качество генерации диалогов персонажей
- Создавать динамические ветвления сюжета на основе выборов игрока

## Лицензия

MIT 