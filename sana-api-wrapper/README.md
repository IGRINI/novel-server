# API-Обертка для SANA Sprint

Этот сервис представляет собой обертку для модели генерации изображений по тексту SANA Sprint. Он предоставляет простой HTTP API для создания изображений. Сервис разработан для запуска на машине с совместимым GPU (например, NVIDIA RTX 4090) и для доступа к нему других сервисов (таких как `image-generator` в проекте TaleShift) по сети.

## Настройка

1.  **Клонирование репозитория SANA (при необходимости):** Вам могут понадобиться части официального репозитория SANA. Клонируйте его, если нужно:
    ```bash
    # git clone https://github.com/NVlabs/Sana.git
    # cd Sana
    # pip install -e . # Или следуйте их инструкциям по установке
    cd ..
    ```

2.  **Установка зависимостей Python:**
    Создайте виртуальное окружение (рекомендуется):
    ```bash
    python -m venv venv
    # Linux/macOS:
    source venv/bin/activate
    # Windows:
    # venv\Scripts\activate
    ```
    Установите необходимые пакеты:
    ```bash
    pip install -r requirements.txt
    ```
    *   **Критически важно:** Вам нужно добавить конкретные зависимости для SANA Sprint в `requirements.txt`, основываясь на его документации (PyTorch, diffusers, transformers и т.д.), и установить их. Убедитесь, что вы устанавливаете правильную версию PyTorch для вашей конфигурации CUDA.

3.  **Загрузка модели SANA Sprint:**
    Скачайте контрольные точки (checkpoints) модели SANA Sprint согласно инструкциям в репозитории SANA. Вам потребуется обновить `main.py`, чтобы указать путь к месту сохранения файлов модели.

4.  **Обновление `main.py`:**
    *   Измените секцию загрузки модели в `main.py`, чтобы она корректно загружала вашу скачанную модель SANA Sprint.
    *   Реализуйте фактическую логику генерации изображений внутри функции `generate_image`, заменив заглушку (placeholder).
    *   Настройте необходимые параметры (например, шаги инференса, guidance scale).

## Запуск Сервиса

```bash
# Убедитесь, что вы находитесь в директории sana-api-wrapper
# и ваше виртуальное окружение активировано

# Пример: Запуск с использованием Uvicorn (при необходимости измените хост/порт)
uvicorn main:app --host 0.0.0.0 --port 8000 --reload
```

*   `--host 0.0.0.0` делает сервер доступным для других машин/контейнеров в вашей сети.
*   `--port 8000` - порт по умолчанию. Измените, если необходимо.
*   `--reload` полезен для разработки, автоматически перезапуская сервер при изменении кода. Удалите для production.

## Конечные точки API (Endpoints)

*   **`POST /generate`**:
    *   Генерирует изображение.
    *   **Тело запроса (JSON):**
        ```json
        {
          "prompt": "Описание изображения",
          "negative_prompt": "Что следует избегать на изображении (необязательно)"
        }
        ```
    *   **Ответ:**
        *   `200 OK`: Возвращает сырые данные изображения JPEG в теле ответа (`Content-Type: image/jpeg`).
        *   `500 Internal Server Error`: Если генерация не удалась.

*   **`GET /health`**:
    *   Базовая проверка состояния.
    *   **Ответ:**
        ```json
        {"status": "ok"}
        ```

## Интеграция с `image-generator` из TaleShift

1.  Запустите эту API-обертку SANA на вашей машине с GPU (например, `uvicorn main:app --host 0.0.0.0 --port 8000`). Запомните IP-адрес этой машины в вашей локальной сети.
2.  Настройте сервис `image-generator` в вашем `docker-compose.yml` (или как вы его запускаете), чтобы он указывал на этот API. Установите переменную окружения `SANA_BASE_URL`:
    *   Если используете Docker Desktop (Mac/Windows): `SANA_BASE_URL=http://host.docker.internal:8000`
    *   Если используете Docker на Linux или нужен конкретный IP: `SANA_BASE_URL=http://<IP_ВАШЕЙ_МАШИНЫ_С_GPU>:8000` (замените `<IP_ВАШЕЙ_МАШИНЫ_С_GPU>` на фактический локальный IP). 